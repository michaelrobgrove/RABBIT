<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RABBIT - Free Open-Source IPTV Player</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@1,900&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-black: #0a0a0a;
            --secondary-black: #1a1a1a;
            --cobalt-blue: #0047FF;
            --cobalt-glow: #1e5eff;
            --white: #ffffff;
            --gray: #a0a0a0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--primary-black);
            color: var(--white);
            overflow-x: hidden;
        }
        .logo-font { font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-style: italic; }
        .hidden { display: none !important; }

        /* Landing Page Styles */
        .landing-page { display: block; }
        .hero {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(ellipse at top, rgba(0, 71, 255, 0.15) 0%, var(--primary-black) 50%);
        }
        .hero-content { text-align: center; max-width: 1200px; padding: 20px; }
        .hero-logo { width: 120px; height: 120px; filter: drop-shadow(0 0 30px rgba(0, 71, 255, 0.5)); margin-bottom: 20px; }
        .hero h1 {
            font-size: clamp(64px, 10vw, 120px);
            background: linear-gradient(135deg, var(--white) 0%, var(--cobalt-glow) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }
        .btn {
            padding: 18px 48px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            border: none;
            text-decoration: none;
            display: inline-block;
            transition: 0.3s;
        }
        .btn-primary {
            background: var(--cobalt-blue);
            color: var(--white);
            box-shadow: 0 0 40px rgba(0, 71, 255, 0.3);
        }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 10px 60px rgba(0, 71, 255, 0.5); }
        .btn-secondary { background: transparent; border: 2px solid var(--white); color: var(--white); }
        .btn-secondary:hover { background: var(--white); color: var(--primary-black); }

        /* App Page Styles */
        .app-page { display: none; min-height: 100vh; }
        .app-page.active { display: block; }
        .app-header {
            background: var(--secondary-black);
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .app-logo { display: flex; align-items: center; gap: 10px; }
        .app-logo img { width: 30px; height: 30px; }
        .app-container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* Login Section */
        .login-section {
            background: var(--secondary-black);
            padding: 40px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 600px;
            margin: 40px auto;
        }
        .method-tabs { display: flex; gap: 10px; margin-bottom: 30px; }
        .tab-btn {
            flex: 1; padding: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--white);
            border-radius: 8px;
            cursor: pointer;
        }
        .tab-btn.active { background: var(--cobalt-blue); border-color: var(--cobalt-blue); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; }
        input {
            width: 100%; padding: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: var(--white);
            font-size: 16px;
        }
        .btn-submit { width: 100%; padding: 14px; background: var(--cobalt-blue); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }

        /* Player Section */
        .player-layout { display: flex; gap: 20px; height: calc(100vh - 100px); }
        .player-main { flex: 2; display: flex; flex-direction: column; gap: 20px; }
        .player-sidebar { flex: 1; background: var(--secondary-black); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; overflow: hidden; }
        
        /* Video Container */
        .video-container {
            position: relative;
            background: black;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 16/9;
        }
        video { width: 100%; height: 100%; }
        
        /* Custom Controls */
        .controls-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            padding: 20px;
            display: flex; justify-content: space-between; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .video-container:hover .controls-overlay { opacity: 1; }
        
        .control-btn {
            background: rgba(255,255,255,0.1); border: none; color: white;
            width: 40px; height: 40px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 18px; transition: 0.2s;
        }
        .control-btn:hover { background: var(--cobalt-blue); }
        .control-group { display: flex; align-items: center; gap: 10px; }
        
        /* Stats for Nerds */
        .stats-overlay {
            position: absolute; top: 10px; left: 10px;
            background: rgba(0,0,0,0.8); color: #0f0;
            padding: 10px; border-radius: 6px;
            font-family: monospace; font-size: 12px;
            pointer-events: none; z-index: 10;
        }

        /* Sidebar Navigation */
        .sidebar-tabs {
            display: flex; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-tab {
            flex: 1; padding: 15px; text-align: center; cursor: pointer;
            font-size: 14px; font-weight: 600; color: var(--gray);
            background: transparent; border: none;
        }
        .sidebar-tab.active { color: var(--white); border-bottom: 2px solid var(--cobalt-blue); background: rgba(255,255,255,0.02); }
        
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; }
        
        /* List Items */
        .list-item {
            padding: 12px; border-radius: 8px; cursor: pointer;
            margin-bottom: 5px; font-size: 14px;
            display: flex; align-items: center; gap: 10px;
        }
        .list-item:hover { background: rgba(255,255,255,0.05); }
        .list-item.active { background: rgba(0, 71, 255, 0.2); border-left: 3px solid var(--cobalt-blue); }
        .item-icon { width: 30px; height: 30px; border-radius: 50%; background: #333; object-fit: cover; }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000;
            align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--secondary-black); padding: 30px;
            border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);
            max-width: 500px; width: 90%;
        }

        @media (max-width: 768px) {
            .player-layout { flex-direction: column; height: auto; }
            .hero h1 { font-size: 48px; }
        }
    </style>
</head>
<body>

    <!-- LANDING PAGE -->
    <div id="landingPage" class="landing-page">
        <section class="hero">
            <div class="hero-content">
                <img src="images/rabbit.svg" alt="Logo" class="hero-logo">
                <h1 class="logo-font">RABBIT</h1>
                <p style="color: var(--gray); margin-bottom: 40px; font-size: 20px;">The Free, Open-Source IPTV Player You Can Trust</p>
                <button class="btn btn-primary" onclick="launchApp()">Launch Player</button>
            </div>
        </section>
    </div>

    <!-- APP PAGE -->
    <div id="appPage" class="app-page">
        <header class="app-header">
            <div class="app-logo">
                <img src="images/rabbit.svg" alt="Logo">
                <span class="logo-font" style="font-size: 24px;">RABBIT</span>
            </div>
            <button class="btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="logout()">Logout</button>
        </header>

        <div class="app-container">
            
            <!-- LOGIN SECTION -->
            <div id="loginSection" class="login-section">
                <h2 style="margin-bottom: 20px;">Connect Service</h2>
                
                <div class="method-tabs">
                    <button class="tab-btn active" onclick="switchTab('xtream')">Xtream Codes</button>
                    <button class="tab-btn" onclick="switchTab('m3u')">M3U Playlist</button>
                </div>

                <!-- Xtream Form -->
                <form id="xtreamForm" onsubmit="loginXtream(event)">
                    <div class="form-group">
                        <label>Server URL</label>
                        <input type="text" id="xtreamUrl" placeholder="http://example.com" required>
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="xtreamUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="xtreamPassword" required>
                    </div>
                    <button type="submit" class="btn-submit">Connect</button>
                </form>

                <!-- M3U Form -->
                <form id="m3uForm" class="hidden" onsubmit="loginM3U(event)">
                    <div class="form-group">
                        <label>Playlist URL</label>
                        <input type="text" id="m3uUrl" placeholder="http://example.com/playlist.m3u" required>
                    </div>
                    <button type="submit" class="btn-submit">Connect</button>
                </form>
            </div>

            <!-- PLAYER SECTION -->
            <div id="playerSection" class="player-layout hidden">
                <div class="player-main">
                    <div class="video-container" id="videoContainer">
                        <video id="videoPlayer" playsinline></video>
                        
                        <!-- Stats Overlay -->
                        <div id="nerdStats" class="stats-overlay hidden">
                            <div>RES: <span id="stat-res">-</span></div>
                            <div>BIT: <span id="stat-bit">-</span> Mbps</div>
                            <div>BUF: <span id="stat-buf">-</span> s</div>
                        </div>

                        <!-- Controls -->
                        <div class="controls-overlay">
                            <div class="control-group">
                                <button class="control-btn" onclick="toggleMute()">
                                    <span id="muteIcon">üîä</span>
                                </button>
                                <input type="range" min="0" max="1" step="0.1" onchange="setVolume(this.value)" style="width: 80px;">
                                <button class="control-btn" onclick="toggleStats()" title="Stats for Nerds">üìä</button>
                            </div>
                            <div class="control-group">
                                <button class="control-btn" onclick="togglePiP()">üì∫</button>
                                <button class="control-btn" onclick="castVideo()">üì°</button>
                                <button class="control-btn" onclick="toggleFullscreen()">‚õ∂</button>
                            </div>
                        </div>
                    </div>
                    <div style="padding: 20px; background: var(--secondary-black); border-radius: 12px;">
                        <h2 id="currentChannelName">Select a channel</h2>
                    </div>
                </div>

                <div class="player-sidebar">
                    <div class="sidebar-tabs">
                        <button class="sidebar-tab active" onclick="switchSidebar('categories')" id="tab-cat">Categories</button>
                        <button class="sidebar-tab" onclick="switchSidebar('channels')" id="tab-chan">Channels</button>
                        <button class="sidebar-tab" onclick="switchSidebar('guide')" id="tab-guide">Guide</button>
                    </div>
                    
                    <div id="list-categories" class="sidebar-content"></div>
                    <div id="list-channels" class="sidebar-content hidden"></div>
                    <div id="list-guide" class="sidebar-content hidden">
                        <div style="padding: 20px; text-align: center; color: var(--gray);">EPG Coming Soon</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ERROR MODAL -->
    <div id="errorModal" class="modal-overlay">
        <div class="modal">
            <h3 style="color: #ff4444; margin-bottom: 15px;">‚ö†Ô∏è Connection Failed</h3>
            <p id="errorMsg" style="color: var(--gray); margin-bottom: 20px; line-height: 1.6;"></p>
            <div id="selfHostInfo" class="hidden">
                <p><strong>Solution: Self-Host RABBIT</strong></p>
                <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; font-family: monospace; margin: 10px 0;">
                    1. Download RABBIT<br>2. python -m http.server 8000
                </div>
                <a href="SELF_HOSTING.md" target="_blank" style="color: var(--cobalt-blue);">View Instructions</a>
            </div>
            <button class="btn-submit" onclick="closeModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <script>
        // --- STATE & PROXIES ---
        let hls = null;
        let statsInterval = null;
        let session = { categories: [], channels: [], activeCat: null };
        const PROXIES = [
            { url: 'https://ether.tfplus.stream/proxy?url=', name: 'Primary Proxy' },
            { url: 'https://corsproxy.io/?url=', name: 'Backup Proxy 1' },
            { url: 'https://thingproxy.freeboard.io/fetch/', name: 'Backup Proxy 2' }
        ];

        // --- NAVIGATION ---
        function launchApp() {
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('appPage').classList.add('active');
            checkSession();
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('form').forEach(f => f.classList.add('hidden'));
            
            if(tab === 'xtream') {
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.getElementById('xtreamForm').classList.remove('hidden');
            } else {
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                document.getElementById('m3uForm').classList.remove('hidden');
            }
        }

        function switchSidebar(view) {
            document.querySelectorAll('.sidebar-tab').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.sidebar-content').forEach(c => c.classList.add('hidden'));
            
            document.getElementById(`tab-${view}`).classList.add('active');
            document.getElementById(`list-${view}`).classList.remove('hidden');
            
            if (view === 'channels' && !session.activeCat && session.categories.length > 0) {
                loadCategory(session.categories[0].id);
            }
        }

        function checkSession() {
            const saved = sessionStorage.getItem('rabbitSession');
            if(saved) {
                session = JSON.parse(saved);
                startPlayer();
            }
        }

        // --- CONNECTION LOGIC ---
        async function smartFetch(url, btn, type='json') {
            btn.textContent = 'Direct Connection...';
            try {
                const res = await fetch(url, { headers: { 'X-User-Agent': 'IPTVSmartersPro' } });
                if(res.ok) {
                    window.lastProxy = '';
                    return type==='json' ? res.json() : res.text();
                }
            } catch(e) {}

            for(const p of PROXIES) {
                btn.textContent = `Using ${p.name}...`;
                try {
                    const res = await fetch(p.url + encodeURIComponent(url));
                    if(res.ok) {
                        window.lastProxy = p.url;
                        return type==='json' ? res.json() : res.text();
                    }
                } catch(e) {}
            }
            throw new Error('Connection failed. Try self-hosting.');
        }

        async function loginXtream(e) {
            e.preventDefault();
            const url = document.getElementById('xtreamUrl').value.replace(///$/, '');
            const user = document.getElementById('xtreamUsername').value;
            const pass = document.getElementById('xtreamPassword').value;
            const btn = e.target.querySelector('button');
            const originalText = btn.textContent;
            
            try {
                // 1. Get Categories
                btn.textContent = 'Fetching Categories...';
                const catUrl = `${url}/player_api.php?username=${user}&password=${pass}&action=get_live_categories`;
                const cats = await smartFetch(catUrl, btn);
                
                // 2. Get Streams
                btn.textContent = 'Fetching Channels...';
                const streamUrl = `${url}/player_api.php?username=${user}&password=${pass}&action=get_live_streams`;
                const streams = await smartFetch(streamUrl, btn);
                
                // 3. Process
                session.categories = cats.map(c => ({ id: c.category_id, name: c.category_name }));
                
                const proxy = window.lastProxy || '';
                session.channels = streams.map(s => {
                    let streamUrl = `${url}/live/${user}/${pass}/${s.stream_id}.m3u8`;
                    if(proxy) streamUrl = proxy + encodeURIComponent(streamUrl);
                    
                    return {
                        name: s.name,
                        logo: s.stream_icon,
                        cat_id: s.category_id,
                        url: streamUrl
                    };
                });

                sessionStorage.setItem('rabbitSession', JSON.stringify(session));
                startPlayer();
            } catch(err) {
                showError(err.message, true);
                btn.textContent = originalText;
            }
        }

        async function loginM3U(e) {
            e.preventDefault();
            const url = document.getElementById('m3uUrl').value;
            const btn = e.target.querySelector('button');
            const originalText = btn.textContent;

            try {
                const data = await smartFetch(url, btn, 'text');
                btn.textContent = 'Parsing...';
                
                const lines = data.split('\n');
                const catSet = new Set();
                const proxy = window.lastProxy || '';
                
                let current = {};
                session.channels = [];
                
                lines.forEach(line => {
                    line = line.trim();
                    if(line.startsWith('#EXTINF')) {
                        const grp = line.match(/group-title="([^"]*)"/);
                        const group = grp ? grp[1] : 'Uncategorized';
                        catSet.add(group);
                        const parts = line.split(',');
                        current = { name: parts[parts.length-1].trim(), cat_id: group };
                    } else if(line && !line.startsWith('#')) {
                        let link = line;
                        if(proxy) link = proxy + encodeURIComponent(link);
                        if(current.name) {
                            session.channels.push({ ...current, url: link });
                            current = {};
                        }
                    }
                });
                
                session.categories = Array.from(catSet).map(c => ({ id: c, name: c }));
                sessionStorage.setItem('rabbitSession', JSON.stringify(session));
                startPlayer();
            } catch(err) {
                showError(err.message, true);
                btn.textContent = originalText;
            }
        }

        function startPlayer() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('playerSection').classList.remove('hidden');
            
            const catList = document.getElementById('list-categories');
            catList.innerHTML = '';
            
            session.categories.forEach(cat => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.textContent = cat.name;
                div.onclick = () => loadCategory(cat.id);
                catList.appendChild(div);
            });
        }

        function loadCategory(id) {
            session.activeCat = id;
            switchSidebar('channels');
            
            const chanList = document.getElementById('list-channels');
            chanList.innerHTML = '';
            
            const filtered = session.channels.filter(c => c.cat_id == id);
            filtered.forEach(ch => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div class="item-icon" style="background-image: url('${ch.logo || ''}')"></div>
                    <span>${ch.name}</span>
                `;
                div.onclick = () => playStream(ch);
                chanList.appendChild(div);
            });
        }

        function playStream(channel) {
            document.getElementById('currentChannelName').textContent = channel.name;
            const video = document.getElementById('videoPlayer');
            
            if (Hls.isSupported()) {
                if(hls) hls.destroy();
                hls = new Hls();
                hls.loadSource(channel.url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = channel.url;
                video.addEventListener('loadedmetadata', () => video.play());
            }
            
            startStats();
        }

        // --- CONTROLS ---
        function toggleMute() {
            const vid = document.getElementById('videoPlayer');
            vid.muted = !vid.muted;
            document.getElementById('muteIcon').textContent = vid.muted ? 'üîá' : 'üîä';
        }
        function setVolume(v) { document.getElementById('videoPlayer').volume = v; }
        async function togglePiP() {
            try {
                if(document.pictureInPictureElement) await document.exitPictureInPicture();
                else await document.getElementById('videoPlayer').requestPictureInPicture();
            } catch(e){}
        }
        function toggleFullscreen() {
            const el = document.getElementById('videoContainer');
            if(!document.fullscreenElement) el.requestFullscreen();
            else document.exitFullscreen();
        }
        function castVideo() { alert('Cast coming soon'); }
        function logout() {
            sessionStorage.removeItem('rabbitSession');
            location.reload();
        }
        
        // --- ERROR ---
        function showError(msg, isSelf) {
            document.getElementById('errorMsg').textContent = msg;
            if(isSelf) document.getElementById('selfHostInfo').classList.remove('hidden');
            document.getElementById('errorModal').classList.add('active');
        }
        function closeModal() { document.getElementById('errorModal').classList.remove('active'); }

        // --- STATS ---
        function toggleStats() { document.getElementById('nerdStats').classList.toggle('hidden'); }
        function startStats() {
            if(statsInterval) clearInterval(statsInterval);
            statsInterval = setInterval(() => {
                const v = document.getElementById('videoPlayer');
                document.getElementById('stat-res').textContent = `${v.videoWidth}x${v.videoHeight}`;
                if(v.buffered.length) {
                     document.getElementById('stat-buf').textContent = (v.buffered.end(v.buffered.length-1) - v.currentTime).toFixed(1);
                }
                if(hls && hls.levels && hls.currentLevel >= 0) {
                     document.getElementById('stat-bit').textContent = (hls.levels[hls.currentLevel].bitrate/1000000).toFixed(2);
                }
            }, 1000);
        }

    </script>
</body>
</html>