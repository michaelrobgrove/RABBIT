<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RABBIT - Pro IPTV Player</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@1,900&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-dark: #000000;
            --bg-panel: #111111;
            --bg-selected: #222222;
            --primary: #0047FF;
            --accent: #1e5eff;
            --text-main: #ffffff;
            --text-dim: #888888;
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- UI UTILITIES --- */
        .hidden { display: none !important; }
        .logo-font { font-family: 'Barlow Condensed', sans-serif; font-style: italic; }
        .btn { border: none; cursor: pointer; border-radius: 8px; font-weight: 600; transition: 0.2s; }
        
        /* --- LANDING PAGE --- */
        #landingPage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }
        
        .hero-logo { width: 120px; height: 120px; margin-bottom: 20px; }
        .hero-title { font-size: 60px; margin-bottom: 10px; color: var(--text-main); }
        .hero-btn { 
            padding: 15px 40px; 
            font-size: 18px; 
            background: var(--primary); 
            color: white;
            margin-top: 30px;
        }

        /* --- MAIN APP LAYOUT --- */
        #appPage {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        /* --- VIDEO PLAYER --- */
        .player-wrapper {
            width: 100%;
            background: black;
            position: relative;
            flex-shrink: 0;
            /* Default height for mobile/portrait */
            height: 35vh; 
            transition: height 0.3s ease;
        }

        /* Fullscreen Video Style within App */
        .player-wrapper.expanded {
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1500;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Custom Controls Overlay */
        .controls-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent 30%);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 15px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .player-wrapper:hover .controls-overlay,
        .player-wrapper.active-touch .controls-overlay {
            opacity: 1;
        }

        .controls-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .icon-btn {
            background: rgba(255,255,255,0.1);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .icon-btn:hover { background: var(--primary); }

        .volume-slider { width: 100px; height: 4px; accent-color: var(--primary); }

        /* Stats For Nerds */
        .stats-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            color: #0f0;
            pointer-events: none;
            z-index: 10;
        }

        /* --- CONTENT AREA (Tabs) --- */
        .content-area {
            flex: 1;
            overflow-y: auto;
            background: var(--bg-dark);
            position: relative;
        }

        .view-section {
            padding: 10px;
            display: none;
        }

        .view-section.active { display: block; }

        /* Grid for Categories/Channels */
        .grid-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .card {
            background: var(--bg-panel);
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80px;
            font-size: 14px;
            font-weight: 500;
        }

        .card:hover { background: var(--bg-selected); }
        .card.active { border-color: var(--primary); background: rgba(0, 71, 255, 0.1); }

        /* List View for Channels */
        .list-view .card {
            flex-direction: row;
            justify-content: flex-start;
            text-align: left;
            gap: 10px;
            min-height: 50px;
        }

        /* --- BOTTOM NAVIGATION --- */
        .bottom-nav {
            background: var(--bg-panel);
            border-top: 1px solid #333;
            display: flex;
            justify-content: space-around;
            padding: 10px 0 calc(10px + var(--safe-area-bottom));
            flex-shrink: 0;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: var(--text-dim);
            font-size: 12px;
            cursor: pointer;
            width: 100%;
        }

        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 20px; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 3000;
            display: flex; align-items: center; justify-content: center;
        }
        .modal {
            background: var(--bg-panel); padding: 30px; border-radius: 15px;
            width: 90%; max-width: 400px; text-align: center; border: 1px solid #333;
        }
        .input-field {
            width: 100%; padding: 15px; margin: 10px 0;
            background: #000; border: 1px solid #333; color: white; border-radius: 8px;
        }
        
        /* Desktop Tweaks */
        @media (min-width: 768px) {
            .player-wrapper { height: 100%; max-width: 60%; }
            #appPage { flex-direction: row; }
            .content-area { flex: 1; border-left: 1px solid #333; }
            .bottom-nav {
                position: absolute; bottom: 0; right: 0; width: 40%; 
                border-top: none; border-left: 1px solid #333;
            }
            /* Move nav to top of content area on desktop? No, stick to request: Bottom */
            .grid-list { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
        }
    </style>
</head>
<body>

    <!-- LANDING / LOGIN -->
    <div id="landingPage">
        <img src="images/rabbit.svg" alt="Logo" class="hero-logo">
        <h1 class="logo-font hero-title">RABBIT</h1>
        <p style="color: #888">Pro IPTV Player ‚Ä¢ HLS Support ‚Ä¢ Privacy First</p>
        
        <div id="loginForms" style="margin-top: 40px; width: 100%; max-width: 350px;">
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button onclick="showForm('m3u')" class="btn" style="flex:1; padding:10px; background:#222; color:#fff" id="tab-m3u">M3U</button>
                <button onclick="showForm('xtream')" class="btn" style="flex:1; padding:10px; background:#222; color:#fff" id="tab-xtream">Xtream</button>
            </div>

            <form id="form-m3u" onsubmit="connectM3U(event)">
                <input type="text" id="m3u-url" class="input-field" placeholder="Playlist URL (M3U)" required>
                <button type="submit" class="btn hero-btn" style="width:100%">Connect</button>
            </form>

            <form id="form-xtream" class="hidden" onsubmit="connectXtream(event)">
                <input type="text" id="x-url" class="input-field" placeholder="Server URL (http://...)" required>
                <input type="text" id="x-user" class="input-field" placeholder="Username" required>
                <input type="password" id="x-pass" class="input-field" placeholder="Password" required>
                <button type="submit" class="btn hero-btn" style="width:100%">Connect</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="appPage" class="hidden">
        
        <!-- PLAYER -->
        <div class="player-wrapper" id="playerWrapper">
            <video id="video" playsinline></video>
            
            <!-- Stats Overlay -->
            <div id="nerdStats" class="stats-overlay hidden">
                <div>RES: <span id="stat-res">-</span></div>
                <div>BIT: <span id="stat-bit">-</span> Mbps</div>
                <div>BUF: <span id="stat-buf">-</span> s</div>
                <div>FPS: <span id="stat-fps">-</span></div>
                <div>CODEC: <span id="stat-codec">-</span></div>
            </div>

            <!-- Controls -->
            <div class="controls-overlay" onclick="toggleTouchUI()">
                <div class="controls-row">
                    <div class="control-group">
                        <!-- Mute -->
                        <button class="icon-btn" onclick="toggleMute(event)">
                            <span id="icon-mute">üîä</span>
                        </button>
                        <!-- Volume -->
                        <input type="range" class="volume-slider" min="0" max="1" step="0.1" onchange="setVolume(this.value)" onclick="event.stopPropagation()">
                        
                        <!-- Stats Toggle -->
                        <button class="icon-btn" onclick="toggleStats(event)" title="Stats for Nerds">
                            <span>üìä</span>
                        </button>
                    </div>

                    <div class="control-group">
                        <!-- PIP -->
                        <button class="icon-btn" onclick="togglePiP(event)" id="btn-pip">
                            <span>üì∫</span>
                        </button>
                        <!-- Cast -->
                        <button class="icon-btn" onclick="castStream(event)">
                            <span>üì°</span>
                        </button>
                        <!-- Fullscreen -->
                        <button class="icon-btn" onclick="toggleFullscreen(event)">
                            <span>‚õ∂</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTENT -->
        <div class="content-area">
            
            <!-- CATEGORIES VIEW -->
            <div id="view-categories" class="view-section active">
                <h2 style="margin-bottom:15px; padding:0 5px;">Categories</h2>
                <div class="grid-list" id="list-categories"></div>
            </div>

            <!-- CHANNELS VIEW -->
            <div id="view-channels" class="view-section">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                    <button class="btn" style="padding:5px 10px; background:#333; color:white;" onclick="navTo('categories')">‚Üê</button>
                    <h2 id="current-cat-name">Channels</h2>
                </div>
                <div class="grid-list list-view" id="list-channels"></div>
            </div>

            <!-- GUIDE VIEW -->
            <div id="view-guide" class="view-section">
                <h2>TV Guide</h2>
                <p style="color:#666; margin-top:20px;">EPG implementation coming in v1.1</p>
            </div>
        </div>

        <!-- BOTTOM NAV -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="navTo('categories')" id="nav-cat">
                <span class="nav-icon">üìÅ</span>
                <span>Categories</span>
            </div>
            <div class="nav-item" onclick="navTo('channels')" id="nav-chan">
                <span class="nav-icon">üì∫</span>
                <span>Channels</span>
            </div>
            <div class="nav-item" onclick="navTo('guide')" id="nav-guide">
                <span class="nav-icon">üìÖ</span>
                <span>Guide</span>
            </div>
        </div>
    </div>

    <!-- ERROR MODAL -->
    <div id="errorModal" class="modal-overlay hidden">
        <div class="modal">
            <h2 style="color: #ff4444; margin-bottom: 15px;">‚ö†Ô∏è Connection Failed</h2>
            <p id="errorMsg" style="color: #ccc; margin-bottom: 20px; line-height: 1.5;"></p>
            <div id="selfHostInfo" class="hidden">
                <div style="background:#222; padding:10px; border-radius:5px; margin:15px 0; text-align:left; font-family:monospace; font-size:12px; color:var(--primary);">
                    1. Download RABBIT<br>
                    2. python -m http.server 8000<br>
                    3. Go to localhost:8000
                </div>
                <a href="SELF_HOSTING.md" target="_blank" style="color:white;">View Instructions</a>
            </div>
            <button class="btn hero-btn" onclick="closeModal()" style="width:100%; margin-top:20px;">Close</button>
        </div>
    </div>

    <script>
        // --- STATE ---
        let hls = null;
        let session = {
            categories: [], // { id, name }
            channels: [],   // { name, url, cat_id, logo }
            activeCat: null
        };
        const PROXIES = [
            { url: 'https://ether.tfplus.stream/proxy?url=', name: 'Ether Proxy' },
            { url: 'https://corsproxy.io/?url=', name: 'CORS.io' },
            { url: 'https://thingproxy.freeboard.io/fetch/', name: 'ThingProxy' }
        ];

        // --- INIT ---
        window.onload = () => {
            // Check Session
            const saved = sessionStorage.getItem('rabbitSession');
            if(saved) {
                try {
                    session = JSON.parse(saved);
                    startApp();
                } catch(e) { sessionStorage.removeItem('rabbitSession'); }
            }
            
            // Tab Init
            showForm('xtream'); // Default to Xtream
        };

        function showForm(type) {
            document.querySelectorAll('#loginForms form').forEach(f => f.classList.add('hidden'));
            document.querySelectorAll('#loginForms button.btn').forEach(b => b.style.background = '#222');
            document.getElementById(`form-${type}`).classList.remove('hidden');
            document.getElementById(`tab-${type}`).style.background = 'var(--primary)';
        }

        // --- CONNECTION LOGIC ---

        async function connectXtream(e) {
            e.preventDefault();
            const url = document.getElementById('x-url').value.replace(///$/, '');
            const user = document.getElementById('x-user').value;
            const pass = document.getElementById('x-pass').value;
            const btn = e.target.querySelector('button');
            const originalText = btn.textContent;

            try {
                // 1. Fetch Categories
                btn.textContent = 'Fetching Categories...';
                const catUrl = `${url}/player_api.php?username=${user}&password=${pass}&action=get_live_categories`;
                const categories = await smartFetch(catUrl, btn);

                // 2. Fetch Streams
                btn.textContent = 'Fetching Channels...';
                const streamUrl = `${url}/player_api.php?username=${user}&password=${pass}&action=get_live_streams`;
                const streams = await smartFetch(streamUrl, btn);

                // 3. Process
                session.categories = categories.map(c => ({ id: c.category_id, name: c.category_name }));
                
                // Determine base URL for streams (Direct or Proxy?)
                // smartFetch attaches the proxy used to the result object property if possible, 
                // but since we return JSON directly, we need a way to know WHICH proxy worked.
                // Simplified: Re-detect proxy for stream construction.
                
                const proxyUsed = window.lastWorkingProxy || ''; 
                
                session.channels = streams.map(s => {
                    let streamLink = `${url}/live/${user}/${pass}/${s.stream_id}.m3u8`;
                    if (proxyUsed) streamLink = proxyUsed + encodeURIComponent(streamLink);
                    
                    return {
                        name: s.name,
                        logo: s.stream_icon,
                        cat_id: s.category_id,
                        url: streamLink
                    };
                });

                saveAndStart();

            } catch (err) {
                showError(err.message, true);
                btn.textContent = originalText;
            }
        }

        async function connectM3U(e) {
            e.preventDefault();
            const url = document.getElementById('m3u-url').value;
            const btn = e.target.querySelector('button');
            const originalText = btn.textContent;

            try {
                btn.textContent = 'Downloading Playlist...';
                const text = await smartFetch(url, btn, 'text');
                
                btn.textContent = 'Parsing...';
                parseM3U(text, url); // Pass original URL to detect relative paths if needed
                
                saveAndStart();
            } catch (err) {
                showError(err.message, true);
                btn.textContent = originalText;
            }
        }

        async function smartFetch(targetUrl, statusBtn, type='json') {
            // 1. Direct
            statusBtn.textContent = 'Direct Connection...';
            try {
                const res = await fetch(targetUrl, { headers: { 'X-User-Agent': 'IPTVSmartersPro' } });
                if(res.ok) {
                    window.lastWorkingProxy = '';
                    return type==='json' ? res.json() : res.text();
                }
            } catch(e) {}

            // 2. Proxies
            for(const p of PROXIES) {
                statusBtn.textContent = `Using ${p.name}...`;
                try {
                    const res = await fetch(p.url + encodeURIComponent(targetUrl));
                    if(res.ok) {
                        window.lastWorkingProxy = p.url;
                        return type==='json' ? res.json() : res.text();
                    }
                } catch(e) {}
            }

            throw new Error('Could not connect to server. Ensure it supports HTTP/HTTPS or try self-hosting.');
        }

        function parseM3U(data, baseUrl) {
            const lines = data.split('\n');
            const cats = new Set();
            session.channels = [];
            
            // Re-detect proxy for streams if M3U was fetched via proxy
            const proxyPrefix = window.lastWorkingProxy || '';

            let currentItem = {};
            
            lines.forEach(line => {
                line = line.trim();
                if(line.startsWith('#EXTINF')) {
                    // Extract Group
                    const groupMatch = line.match(/group-title="([^"]*)"/);
                    const group = groupMatch ? groupMatch[1] : 'Uncategorized';
                    cats.add(group);
                    
                    // Extract Name
                    const nameParts = line.split(',');
                    const name = nameParts[nameParts.length-1].trim();
                    
                    currentItem = { name, cat_id: group };
                } else if(line && !line.startsWith('#')) {
                    let url = line;
                    if (proxyPrefix) url = proxyPrefix + encodeURIComponent(url);
                    
                    if(currentItem.name) {
                        session.channels.push({ ...currentItem, url });
                        currentItem = {};
                    }
                }
            });

            session.categories = Array.from(cats).map(c => ({ id: c, name: c }));
        }

        function saveAndStart() {
            sessionStorage.setItem('rabbitSession', JSON.stringify(session));
            startApp();
        }

        function startApp() {
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('appPage').classList.remove('hidden');
            renderCategories();
        }

        // ---NAVIGATION & RENDERING ---

        function navTo(view) {
            // Update Tab UI
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const navId = view === 'categories' ? 'nav-cat' : (view === 'channels' ? 'nav-chan' : 'nav-guide');
            document.getElementById(navId).classList.add('active');

            // Show View
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById(`view-${view}`).classList.add('active');
            
            // Special Logic
            if(view === 'channels' && !session.activeCat && session.categories.length > 0) {
                // If clicked channels tab but no category selected, select first
                loadCategory(session.categories[0].id);
            }
        }

        function renderCategories() {
            const container = document.getElementById('list-categories');
            container.innerHTML = '';
            
            session.categories.forEach(cat => {
                const div = document.createElement('div');
                div.className = 'card';
                div.textContent = cat.name;
                div.onclick = () => loadCategory(cat.id);
                container.appendChild(div);
            });
        }

        function loadCategory(catId) {
            session.activeCat = catId;
            const cat = session.categories.find(c => c.id == catId);
            if(cat) document.getElementById('current-cat-name').textContent = cat.name;
            
            renderChannels(catId);
            navTo('channels');
        }

        function renderChannels(catId) {
            const container = document.getElementById('list-channels');
            container.innerHTML = '';
            
            const filtered = session.channels.filter(c => c.cat_id == catId);
            
            filtered.forEach(ch => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <div style="width:30px; height:30px; background:#333; border-radius:50%; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                        ${ch.logo ? `<img src="${ch.logo}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;" onerror="this.style.display='none'">` : 'üì∫'}
                    </div>
                    <span>${ch.name}</span>
                `;
                div.onclick = () => playStream(ch.url);
                container.appendChild(div);
            });
        }

        // --- PLAYER LOGIC ---

        function playStream(url) {
            const video = document.getElementById('video');
            
            if (Hls.isSupported()) {
                if(hls) hls.destroy();
                hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: true,
                });
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Safari
                video.src = url;
                video.addEventListener('loadedmetadata', () => video.play());
            }
            
            // Start Stats Loop
            startStatsLoop();
        }

        // --- CONTROLS ---

        function toggleMute(e) {
            e.stopPropagation();
            const video = document.getElementById('video');
            video.muted = !video.muted;
            document.getElementById('icon-mute').textContent = video.muted ? 'üîá' : 'üîä';
        }

        function setVolume(val) {
            const video = document.getElementById('video');
            video.volume = val;
            video.muted = false;
            document.getElementById('icon-mute').textContent = 'üîä';
        }

        async function togglePiP(e) {
            e.stopPropagation();
            const video = document.getElementById('video');
            try {
                if (video !== document.pictureInPictureElement) {
                    await video.requestPictureInPicture();
                } else {
                    await document.exitPictureInPicture();
                }
            } catch(err) { console.error(err); }
        }

        function toggleFullscreen(e) {
            e.stopPropagation();
            const wrapper = document.getElementById('playerWrapper');
            if(!document.fullscreenElement) {
                wrapper.requestFullscreen();
                wrapper.classList.add('expanded');
            } else {
                document.exitFullscreen();
                wrapper.classList.remove('expanded');
            }
        }
        
        function castStream(e) {
            e.stopPropagation();
            // Placeholder for Google Cast API integration
            // Requires standardized receiver app ID
            alert("Cast requires a hosted sender application ID. In progress.");
        }

        // --- STATS FOR NERDS ---
        
        let statsInterval;
        function toggleStats(e) {
            e.stopPropagation();
            document.getElementById('nerdStats').classList.toggle('hidden');
        }

        function startStatsLoop() {
            if(statsInterval) clearInterval(statsInterval);
            statsInterval = setInterval(() => {
                const video = document.getElementById('video');
                
                // Resolution
                document.getElementById('stat-res').textContent = `${video.videoWidth}x${video.videoHeight}`;
                
                if(hls) {
                    // Bitrate (approx)
                    if(hls.levels && hls.currentLevel >= 0) {
                        const level = hls.levels[hls.currentLevel];
                        const bitrate = (level.bitrate / 1000000).toFixed(2);
                        document.getElementById('stat-bit').textContent = bitrate;
                        document.getElementById('stat-codec').textContent = level.videoCodec;
                    }
                }
                
                // Buffer
                if(video.buffered.length > 0) {
                    const bufEnd = video.buffered.end(video.buffered.length - 1);
                    const health = (bufEnd - video.currentTime).toFixed(1);
                    document.getElementById('stat-buf').textContent = health;
                }

            }, 1000);
        }

        // --- MODALS ---
        function showError(msg, isSelfHost) {
            document.getElementById('errorMsg').textContent = msg;
            if(isSelfHost) document.getElementById('selfHostInfo').classList.remove('hidden');
            document.getElementById('errorModal').classList.remove('hidden');
        }
        function closeModal() {
            document.getElementById('errorModal').classList.add('hidden');
        }
        
        // --- MOBILE TOUCH UX ---
        function toggleTouchUI() {
            const wrapper = document.getElementById('playerWrapper');
            wrapper.classList.toggle('active-touch');
        }

    </script>
</body>
</html>